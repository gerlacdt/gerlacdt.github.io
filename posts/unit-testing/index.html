<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Why and How to write better Unit Tests | Daniel's programming rants</title><meta name=keywords content="programming,testing"><meta name=description content="TL;DR  Good unit tests build the foundation of a maintainable and high-quality codebase Unit Tests should help developers to be productive Unit Tests should be fast Unit Tests should be isolated Unit Tests should be deterministic Unit Tests should focus on a single unit Unit Tests should be enduring Unit Tests should be clear, concise and complete  Avoid complex control flow logic like nested ifs or loops Unit Tests should follow a consistent naming pattern like UnitName_StateUnderTest_ExpectedBehavior Unit Tests should comply to a consistent structure Unit Tests should be DAMP not DRY   Unit Tests should give developers confidence to deploy and to refactor Test Doubles help to make tests fast and deterministic The overuse of Mocking makes test hard to read and brittle Prefer state verification over interaction verification Prevent brittle tests Prevent flaky tests Read more:  Software Engineering at Google Kent Becks&rsquo;s Programmer Test Principles Microsoft&rsquo;s Best Practices for Unit testing    Why good unit tests are important TDD and test engineering culture is considered best practice these days."><meta name=author content="Daniel Gerlach"><link rel=canonical href=https://gerlacdt.github.io/posts/unit-testing/><link crossorigin=anonymous href=/assets/css/stylesheet.min.48a18943c2fc15c38a372b8dde1f5e5dc0bc64fa6cb90f5a817d2f8c76b7f3ae.css integrity="sha256-SKGJQ8L8FcOKNyuN3h9eXcC8ZPpsuQ9agX0vjHa3864=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.4dcb3c4f38462f66c6b6137227726f5543cb934cca9788f041c087e374491df2.js integrity="sha256-Tcs8TzhGL2bGthNyJ3JvVUPLk0zKl4jwQcCH43RJHfI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://gerlacdt.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://gerlacdt.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://gerlacdt.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://gerlacdt.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://gerlacdt.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-138086762-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="Why and How to write better Unit Tests"><meta property="og:description" content="TL;DR  Good unit tests build the foundation of a maintainable and high-quality codebase Unit Tests should help developers to be productive Unit Tests should be fast Unit Tests should be isolated Unit Tests should be deterministic Unit Tests should focus on a single unit Unit Tests should be enduring Unit Tests should be clear, concise and complete  Avoid complex control flow logic like nested ifs or loops Unit Tests should follow a consistent naming pattern like UnitName_StateUnderTest_ExpectedBehavior Unit Tests should comply to a consistent structure Unit Tests should be DAMP not DRY   Unit Tests should give developers confidence to deploy and to refactor Test Doubles help to make tests fast and deterministic The overuse of Mocking makes test hard to read and brittle Prefer state verification over interaction verification Prevent brittle tests Prevent flaky tests Read more:  Software Engineering at Google Kent Becks&rsquo;s Programmer Test Principles Microsoft&rsquo;s Best Practices for Unit testing    Why good unit tests are important TDD and test engineering culture is considered best practice these days."><meta property="og:type" content="article"><meta property="og:url" content="https://gerlacdt.github.io/posts/unit-testing/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-05-04T08:08:00+02:00"><meta property="article:modified_time" content="2020-05-04T08:08:00+02:00"><meta property="og:site_name" content="Daniel's programming rants"><meta name=twitter:card content="summary"><meta name=twitter:title content="Why and How to write better Unit Tests"><meta name=twitter:description content="TL;DR  Good unit tests build the foundation of a maintainable and high-quality codebase Unit Tests should help developers to be productive Unit Tests should be fast Unit Tests should be isolated Unit Tests should be deterministic Unit Tests should focus on a single unit Unit Tests should be enduring Unit Tests should be clear, concise and complete  Avoid complex control flow logic like nested ifs or loops Unit Tests should follow a consistent naming pattern like UnitName_StateUnderTest_ExpectedBehavior Unit Tests should comply to a consistent structure Unit Tests should be DAMP not DRY   Unit Tests should give developers confidence to deploy and to refactor Test Doubles help to make tests fast and deterministic The overuse of Mocking makes test hard to read and brittle Prefer state verification over interaction verification Prevent brittle tests Prevent flaky tests Read more:  Software Engineering at Google Kent Becks&rsquo;s Programmer Test Principles Microsoft&rsquo;s Best Practices for Unit testing    Why good unit tests are important TDD and test engineering culture is considered best practice these days."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://gerlacdt.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Why and How to write better Unit Tests","item":"https://gerlacdt.github.io/posts/unit-testing/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Why and How to write better Unit Tests","name":"Why and How to write better Unit Tests","description":"TL;DR  Good unit tests build the foundation of a maintainable and high-quality codebase Unit Tests should help developers to be productive Unit Tests should be fast Unit Tests should be isolated Unit Tests should be deterministic Unit Tests should focus on a single unit Unit Tests should be enduring Unit Tests should be clear, concise and complete  Avoid complex control flow logic like nested ifs or loops Unit Tests should follow a consistent naming pattern like UnitName_StateUnderTest_ExpectedBehavior Unit Tests should comply to a consistent structure Unit Tests should be DAMP not DRY   Unit Tests should give developers confidence to deploy and to refactor Test Doubles help to make tests fast and deterministic The overuse of Mocking makes test hard to read and brittle Prefer state verification over interaction verification Prevent brittle tests Prevent flaky tests Read more:  Software Engineering at Google Kent Becks\u0026rsquo;s Programmer Test Principles Microsoft\u0026rsquo;s Best Practices for Unit testing    Why good unit tests are important TDD and test engineering culture is considered best practice these days.","keywords":["programming","testing"],"articleBody":"TL;DR  Good unit tests build the foundation of a maintainable and high-quality codebase Unit Tests should help developers to be productive Unit Tests should be fast Unit Tests should be isolated Unit Tests should be deterministic Unit Tests should focus on a single unit Unit Tests should be enduring Unit Tests should be clear, concise and complete  Avoid complex control flow logic like nested ifs or loops Unit Tests should follow a consistent naming pattern like UnitName_StateUnderTest_ExpectedBehavior Unit Tests should comply to a consistent structure Unit Tests should be DAMP not DRY   Unit Tests should give developers confidence to deploy and to refactor Test Doubles help to make tests fast and deterministic The overuse of Mocking makes test hard to read and brittle Prefer state verification over interaction verification Prevent brittle tests Prevent flaky tests Read more:  Software Engineering at Google Kent Becks’s Programmer Test Principles Microsoft’s Best Practices for Unit testing    Why good unit tests are important TDD and test engineering culture is considered best practice these days. Alas, I often encounter projects without tests or with bad tests. Maybe you experienced this yourself, you changed something in a specific part of the system and suddenly a lot of unrelated tests fail. Congratulations, you made the acquaintance of brittle tests. This is not only annoying for developers but also a time killer. Another kind of bad tests are flaky tests. They are non-deterministic due to relying on remote systems, making network calls or accessing remote databases. This causes tests to randomly succeed or fail even when production code has not changed.\nBoth, brittle and flaky, tests are a serious problems in a codebase and should be shunned. Otherwise they will succumb progressively more and more time and effort of the developers. Finally developers are kept busy with repairing broken tests and productivity suffers. This can happen in disguise and developers are not even aware of the problem. In some companies test coverage is treated as a key metric. Hence if the coverage high, nobody will question the current situation. Maybe the whole involved team is proud of the high coverage, not recognizing their real problem.\nMaintainable, fast and deterministic unit tests build the foundation of a sustainable codebase. But unit tests alone are not enough to guarantee a usable, successful and bug-free application. Additionally you need system and UI tests in order to verify production readiness. The test pyramid visualizes this.\nSystem tests and UI tests are good to check your product as a whole, but these tests are slow, flaky, not repeatable and often are conducted manually which makes them bad candidates for continuous integration and delivery. If system tests fail, it is hard for developers to locate the problem because the scope of a system test is very broad and not as focused as in a unit test. Relying heavily in a project on manual regression testing instead of an exhaustive, automatic test suite is an anti-pattern, the test ice cone. It is the inverse of the test pyramid and leads to an unsustainable codebase because failing system tests leave developers in the dark about the root cause and drain their productivity. Did you ever work in a project with a Jira Board, cluttered with unresolved Bugs in the backlog? – all bugs found by so-called manual QAs or testers.\nIn this article I will focus on unit tests. Good unit tests should be clean, maintainable and most notably “useful” for developers. The main purpose of tests is to save time for developers and keep the code quality high. But careless use of testing can have negative effects on productivity and code quality. E.g if developers loose a majority of their time fixing tests instead of building new features. “Wrong” testing can result in a system that requires even more effort to maintain than without tests and takes more effort to change without actually improving confidence in the next production release. It is crucial to identify bad tests and to know how to write good tests.\nThis blog post is built upon the shoulder of giants. Basically I draw from the fantastic book Software Engineering at Google . Especially from Chapter 12 “Unit Testing”. I was also heavily inspired by the article about Programmer Test Principles from Kent Beck, the father of TDD.\nTest Doubles Test Doubles play a crucial part in writing good unit tests, we’ll see soon. But first, let’s define what a Test Double is. A Test Double is a replacement of a production code class or function. Multiple types of Test Doubles exist. In my opinion, the three most important ones are:\n A Fake is a simplified implementation of a given interface, for example a FakeUserRepository “fakes” the real database repository behaviour with an in-memory Hashmap. A Fake is used interchangeably with a real implementation and is typically applied via dependency injection. A Stub returns predefined, hard-coded values to specific calls which are internally needed by the SUT (System Under Test) to fulfill the tested behaviour. A Mock is a stub, but additionally checks the interactions of the mock with its environment. For example, was the mock called with the expected parameters or was the mocked method called an expected number of times? Checking the interactions of mocks is also called interaction testing. Naturally both, Stubbing and Mocking, is realized via mock-frameworks.  An exhaustive list of Test Double types can be found in Martin Fowler’s article.\nThe following is a fake implementation of a UserRepository. An in-memory Hashmap replaces a real database. The Fake can be used by a unit test via dependency injection. There will be a relevant example with an example usage later on.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  // Fake example  public interface UserRepository {  public void save(User user);  public User findById(String id); }   // Fakes the UserRepository interface with a HashMap implementation  public class FakeUserRepository implements UserRepository {   private MapString, User users = new HashMap();   @Override  public void save(User user) {  users.put(user.getId(), user);  }   @Override  public User findById(String id) {  return users.get(id);  } }   The next example shows a simple mock which stubs a method of the UserRepository. Without the interaction verification at the end of the test, the mock would be a simple stub.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  // Mock example  import static org.mockito.Mockito.*;  public class UserServiceMockTest {   UserRepository mockUserRepository = mock(UserRepository.class);   // dependency injection  UserService sut = new UserService(mockUserRepository);   @Test  public void getUser_ReturnUser() {  // arrange  User user = new User(\"userId\");  when(mockUserRepository.findById(anyString())).thenReturn(user); // stubbing   // act  User actual = sut.getUser(\"userId\");   // assert  assertEquals(\"userId\", actual.getId());   // verify interaction  // check that findById() was called with the correct parameter and exactly once  verify(mockUserRepository, times(1)).findById(\"userId\");  } }   What makes a good unit test? There are a lot of opinions floating around about how to write good unit tests. In the following I list the traits which I consider most important.\nTests should be fast A useful test suite will be run frequently, sometimes multiple times a minute, and therefore must be fast, i.e. a few seconds at most. Loosing focus during the run is unwanted because it decreases productivity and breaks the flow. Further if unit tests are slow, developers will not run tests regularly or skip running them completely. Then tests will loose their purpose, namely providing fast feedback. Martin Fowler speaks of a compile suite and a commit suite. Normally developers work on a specific part or unit of a system like a single file or class. With every compilation, they only run the related tests to get feedback as fast as possible. Hence this group of tests is the “compile suite”. The compile suite comprises the smallest set of tests which verify the correctness of the unit of the system which is currently worked on. After finishing a feature or bugfix, before committing, all unit tests are run to check if nothing else is broken. Hence this group of tests is called the “commit suite”.\nThe optimal duration of a unit test is in the nanosecond range. Hundred milliseconds sounds fast for a single unit test but it is too slow if you think about a project with multiple thousand tests. All tests would take minutes to complete. A developer will only reluctantly wait or even worse he will skip running the tests.\nTests, relying on network calls, database queries or time related logic, are inherently slow. Test Doubles are a mechanism to make tests fast and reliable. With a Test Double you inject a fake implementation replacing the database or HTTP call. This technique is well known as Dependency Injection.\nIn the code block below the UserService uses the UserRepository to carry out the intended business logic. A real UserRepository talks naturally to a database and is too slow for a unit test. Here the real database implementation is substituted with a FakeUserRepository from above.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  public class UserServiceTest {   // test double  UserRepository fakeUserRepository = new FakeUserRepository();   // dependency injection  UserService sut = new UserService(fakeUserRepository);   @Test  public void registerUser_validUser_success() {  // arrange  User user = new User(\"foobar\");   // act  sut.registerUser(user);   // assert  User u = sut.getUser(user.getId());  assertNotNull(u);  } }   Tests should be isolated Tests should be independent from each other. It must be possible to run the tests in any order, concurrently and in parallel. This becomes especially important when the project is big and contains thousand of tests. In order to speed up the build, the workload can be distributed across different machines. The distribution logic is very simple if the tests are isolated. Contrary, it would be very hard or even impossible to distribute tests which make up a complex dependency graph. Further any single unit test should be able to run alone without depending on other unit tests, files, network I/O, and databases.\nBelow there is an example of a bad unit test. The second test depends on the first one and it will fail if the first test did not run before or failed. Not only this eradicates the possibility to distribute the tests but also developers will have a hard time to figure out the root cause of the potential error. Did the second test fail because of itself or because of the test before?\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  // BAD // tests depend on each other and cannot run in random order or concurrently  @TestMethodOrder(MethodOrderer.OrderAnnotation.class) public class BankAccountServiceOrderedTest {   BankAccountService sut = new BankAccountService();  User user = new User(\"userId\");   @Test  @Order(1)  public void createAccount_validUser_ok() {  // act  sut.createAccount(user);   // assert  boolean actual = sut.hasAccount(user.getId());  assertTrue(actual);  }   @Test  @Order(2)  public void deposit_100Dollars_ok() {  // arrange  Integer amount = 100;   // act  Integer actual = sut.deposit(user, amount);   // assert  Integer expected = 100;  assertEquals(expected, actual);  } }   The second example shows two independent tests. The small cost of adding 2-3 lines per tests is more than acceptable.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  // GOOD // tests can run in random order and concurrently  @TestMethodOrder(MethodOrderer.Random.class) public class BankAccountServiceTest {   BankAccountService sut = new BankAccountService();   @BeforeEach  public void beforeEach() {  sut.resetAll();  }   @Test  public void deposit_100Dollars_ok() {  // arrange  User user = new User(\"userId\");  sut.createAccount(user);  Integer amount = 100;   // act  Integer actual = sut.deposit(user, amount);   // assert  Integer expected = 100;  assertEquals(expected, actual);  }   @Test  public void withdraw_50Dollars_ok() {  // arrange  User user = new User(\"userId\");  sut.createAccount(user);  sut.deposit(user, 100);  Integer amount = 50;   // act  Integer actual = sut.withdraw(user, amount);   // assert  Integer expected = 50;  assertEquals(expected, actual);  } }   Tests should be deterministic A deterministic test never changes its outcome when there was no change of behaviour. A test switching from green to red or the other way around without any change is called flaky. Test Doubles are a good way to get rid of flaky dependencies like external network or database calls. The earlier example with the FakeUserRepository demonstrates this.\nTests should focus on a single unit of the system A unit test should focus on a single part of the system. If a unit tests breaks, it should be easy to find the root cause. The other way around is also true: If someone changes a unit, only corresponding unit tests should possibly break. If you need to start a debugger to figure out what went wrong, the chance is high that your tests are too diffuse and include much more than a single unit.\nUnit tests which not focus on a single unit tend to be brittle because they will fail if some other part of the system changes. Brittle tests are a serious problem because developers loose trust in the test suite and they neglect badly needed refactorings. This hampers maintainability and causes the quality of the codebase to degrade. More often than not, in many projects existing unit tests are more a burden than a backing for the developers.\nOften there is a misunderstanding of what “focus on one unit” exactly means. Here the two types of testing, the classic testing and the mockist testing, come into play. The “mockists” are very strict and mock all dependencies. The mock-everything approach isolates the test from the rest of the world but comes with major disadvantages. First, the unit tests are polluted with various mock-statements which makes the real test logic hard to understand. And second, with mocking the dependencies, you expose the internals of the unit. This is a major bummer because once the internals are exposed, future refactorings are impossible without breaking a majority of existing tests. The “classic tester” avoid mocks and use Fakes or real implementations for dependencies. Hence the internals are kept hidden and refactorings are still possible.\nYou can find a great definition about “focus on a single unit” in the book Software Engineering at Google:\n It’s important to note that when we talk about unit tests as being narrowly scoped, we’re referring to the code that is being validated, not the code that is being executed.\n Tests should be enduring Strive for unchangeable tests. A test should be written once and never be touched except there is a change of behaviour in the corresponding unit. Changes of internals should never break a test if the behaviour stays the same. Like I mentioned earlier these are brittle tests. We should prevent them at any cost.\nBrittle tests can creep into the codebase because of the overuse of mocks. Mocks verify if specific methods get called. Hence mocks know about the internal implementation which makes the tests prone to failures. If the internal implementation changes, you need to adjust all tests which use related mocks. In large codebases this means a lot of effort.\nTest only public methods. I often see developers who test private methods. Therefore they make them public or protected. This contradicts the concept of information hiding and low coupling. Then you expose the internals of a unit which makes it impossible to switch the internal implementation without breaking a majority of tests. Additionally, you crippled the module’s contract and swamped its interface with confusing public methods which should be private.\nTests should be clear, concise and complete A test should be clear, concise and complete. What does that mean exactly? A clear test is easy to read and to understand. Tests should not include complex logic like nested if-conditions or complicated loops. A clear test is a simple sequence of expressions without any branching. Consistency is critical. All tests in a project should comply to a common structure like arrange-act-assert or given-when-then. A consistent structure reduces cognitive load and gives developers, unfamiliar with the codebase, a prescriptive model how a test should look like. A consistent naming pattern adds clarity and bolsters readability. A collection of common patterns can be found here. My preferred one is UnitName_StateUnderTest_ExpectedBehavior. Rich failure messages are important too. A message with a detailed context where and why the test failed, reduces debugging effort immensely. According to Microsoft you should create a separate test for each assertion. In case of a test failure, a single assertion helps to demystify the error. Most testing-frameworks anyway stop during the first assertion error per test. At best, a visible correlation from the test name to the assertion statement exist. Multiple assertions could be useful though for asserting multiple attributes of a complex object or checking expected side-effects.\nThe following test shows one good assertion and some unnecessary ones:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  public class PaymentServiceTest {   PaymentService sut = new PaymentService(new PaymentGateway());   @Test  @DisplayName(\"payment with valid user\")  void pay_validUser_success() {  // arrange  User user = new User(\"userId\");  user.setHasValidCreditCard(true);  int amount = 750;  PaymentRequest request = new PaymentRequest(user, amount);   // act  PaymentResponse actual = sut.pay(request);   // assert  // GOOD one assert is enough to cover the test case  boolean expected = true;  assertEquals(expected, actual.isSuccess());   // BAD  // unnecessary over-assertion  assertEquals(expectedReason, actual.getReason());  assertEquals(expectedStateOfSUT, sut.getState());  assertEquals(expectedOther, otherStuffNonRelatedToTest);  } }   Completeness and conciseness contradict themselves. A good test finds a balance of both. The highest priority is readability though which is fostered by completeness. A complete test contains all dependencies, pre-configured objects and data needed to run the test. The apt developer must resist the urge to make the test too DRY (Don’t Repeat Yourself). DRY code scatters important shared logic and hurts readability. Relying too much on shared helper classes and functions reduces the amount of code but increases coupling and makes tests brittle. Google’s Testing on the Toilet Blog favors the DAMP principle (Descriptive And Meaningful Phrases) over the DRY principle for tests. A little duplication improves comprehension and should be preferred over uniqueness. If you think complete tests are too verbose or your tests require lots of setup code, it could be an indicator that your production code is flawed and you should rethink your overall design.\nThe following examples show a test in a DRY and a DAMP version. The DRY version uses shared helper functions like createUsers() or validate() with unclear semantics. The DAMP version replaces these magical functions with a simple constructor call and an assertion statement.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34   // BAD  // test is too DRY  // What kind of users will be created by the createUsers() function? // What will be asserted by the validate() function?  class PaymentServiceDRYTest {   // magical helper function  ListUser users = createUsers(); // how many users will be created?   @Test  @DisplayName(\"payment with valid user\")  void pay_validUser_success() {  // arrange  PaymentService sut = new PaymentService(new PaymentGateway());   // BAD  // which user in the list is a valid one?  PaymentRequest request = new PaymentRequest(users.get(0), 750);   // act  PaymentResponse actual = sut.pay(request);   // assert  // magical helper function  validate(actual, true, null); // what are these parameters?   // validate() is used in other contexts too  // the three parameters are: validate(actual, expected, errorMessage)  } }   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  // GOOD  // Test is DAMP  // all information needed for the test are inside the test  public class PaymentServiceDAMPTest {   PaymentService sut = new PaymentService(new PaymentGateway());   @Test  @DisplayName(\"payment with valid user\")  void pay_validUser_success() {  // arrange  User user = new User(\"userId\");  user.setHasValidCreditCard(true);  int amount = 750;  PaymentRequest request = new PaymentRequest(user, amount);   // act  PaymentResponse actual = sut.pay(request);   // assert  boolean expected = true;  assertEquals(expected, actual.isSuccess());  } }   Nevertheless conciseness is important too and must not be neglected. A deliberate usage of shared helpers makes this possible. For example, after calling the helper function you could explicitly set the needed properties for the test on the returned object. So you utilize the shared helper function but also decouple the test from it. Further the relevant properties, needed by the test, are made prominent and the test will be stable even if someone changes the helper logic. The example below illustrates that.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  // BAD use of shared helper function.  // We don't know about the properties of the created user.  // If someone changes createDefaultUser(), the test could break.   @Test  void pay_validUser_success3() {  // arrange  User user = createDefaultUser();  int amount = 750;  PaymentRequest request = new PaymentRequest(user, amount);   // act  PaymentResponse actual = sut.pay(request);   // assert  boolean expected = true;  assertEquals(expected, actual.isSuccess());  }   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24   // GOOD use of shared helper function.  // Set properties which matter for the test explicitly.  // Test is complete. // You understand the test without checking createDefaultUser(). // Even if someone changes createDefaultUser(), the test will be ok.   @Test  void pay_validUser_success2() {  // arrange  User user = createDefaultUser();  user.setHasValidCreditCard(true);  int amount = 750;  PaymentRequest request = new PaymentRequest(user, amount);   // act  PaymentResponse actual = sut.pay(request);   // assert  boolean expected = true;  assertEquals(expected, actual.isSuccess());  }   Tests should give you confidence (and a good feeling) Finally your test suite should give you confidence that your code changes are correct and you did not break anything. A green suite is an indicator that you can deploy to production without worries. Green tests should give the individual developer a good feeling about his code changes. Thereby tests act as a productivity booster so you can make changes faster and deliver features in less time – always feeling good at it.\nThe Fallacy Of Mocking We learned that mocks make unit tests fast and deterministic. They prevent flaky tests because they replace unstable calls or slow network calls with predefined, hard-coded behaviour. There is a catch though. The overuse of mocking or stubbing has a negative effect on your test code quality:\n  Tests become unclear because mock statements bloat the code and make the test hard to comprehend. The maintainability of your test code suffers.\n  Tests become brittle. The more you mock, the more internals of the SUT are leaked. Changing the internals, even without changing the behaviour of the SUT, could make the test fail which contradicts the principle of enduring tests.\n  A need of too many mocks could be an indicator of bad design. Most probably the SUT has too many dependencies and responsibilities and should be divided.\n  Google also warns about the overuse of mock-frameworks and interaction testing. Nevertheless interaction testing is sometimes the only way to check the code correctness. For example in order to check a caching logic, you need to call a function twice. First to get object and to fill the cache, second to get the object from the cache. Both returned objects are indistinguishable. The only way to verify that the second object was retrieved from the cache is to check if the cache was called. Another insight from Google is that they prefer Fakes over Mocks. Fakes are not that intrusive and the test code is not swamped by stubbing-behaviour statements.\nFinal words I know some presented traits are idealistic. Ideals are often hard or even impossible to achieve. Nevertheless these “ideals” should serve you as a guide star. I hope you gained some new insights and understand that good unit tests play a crucial part for a successful software project. Especially identifying good and bad tests is important, so you do not fall into the trap of brittle or flaky tests. Eventually tests exist to make the life of developers easier. When tests do not increase productivity, confidence and code quality, they failed their purpose. I also hope that I could eliminate some fallacies about mocking or that chasing a 100% code coverage is nonsense. As long developers feel confident about their codebase and refactorings are done regularly everything is fine.\n","wordCount":"4111","inLanguage":"en","datePublished":"2020-05-04T08:08:00+02:00","dateModified":"2020-05-04T08:08:00+02:00","author":{"@type":"Person","name":"Daniel Gerlach"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://gerlacdt.github.io/posts/unit-testing/"},"publisher":{"@type":"Organization","name":"Daniel's programming rants","logo":{"@type":"ImageObject","url":"https://gerlacdt.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://gerlacdt.github.io/ accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://gerlacdt.github.io/posts/ title=posts><span>posts</span></a></li><li><a href=https://gerlacdt.github.io/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://gerlacdt.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://gerlacdt.github.io/posts/>Posts</a></div><h1 class=post-title>Why and How to write better Unit Tests</h1><div class=post-meta><span title="2020-05-04 08:08:00 +0200 CEST">May 4, 2020</span>&nbsp;·&nbsp;20 min&nbsp;·&nbsp;Daniel Gerlach</div></header><div class=post-content><h3 id=tldr>TL;DR<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h3><ul><li>Good unit tests build the foundation of a maintainable and high-quality
codebase</li><li>Unit Tests should help developers to be productive</li><li>Unit Tests should be fast</li><li>Unit Tests should be isolated</li><li>Unit Tests should be deterministic</li><li>Unit Tests should focus on a single unit</li><li>Unit Tests should be enduring</li><li>Unit Tests should be clear, concise and complete<ul><li>Avoid complex control flow logic like nested ifs or loops</li><li>Unit Tests should follow a consistent naming pattern like <em>UnitName_StateUnderTest_ExpectedBehavior</em></li><li>Unit Tests should comply to a consistent structure</li><li>Unit Tests should be <a href=https://testing.googleblog.com/2019/12/testing-on-toilet-tests-too-dry-make.html>DAMP not
DRY</a></li></ul></li><li>Unit Tests should give developers confidence to deploy and to refactor</li><li>Test Doubles help to make tests fast and deterministic</li><li>The overuse of Mocking makes test hard to read and brittle</li><li>Prefer state verification over interaction verification</li><li>Prevent brittle tests</li><li>Prevent flaky tests</li><li>Read more:<ul><li><a href=https://www.oreilly.com/library/view/software-engineering-at/9781492082781/>Software Engineering at Google</a></li><li><a href=https://medium.com/@kentbeck_7670/programmer-test-principles-d01c064d7934>Kent Becks&rsquo;s Programmer Test
Principles</a></li><li><a href=https://docs.microsoft.com/en-us/dotnet/core/testing/unit-testing-best-practices>Microsoft&rsquo;s Best Practices for Unit
testing</a></li></ul></li></ul><h3 id=why-good-unit-tests-are-important>Why good unit tests are important<a hidden class=anchor aria-hidden=true href=#why-good-unit-tests-are-important>#</a></h3><p>TDD and test engineering culture is considered best practice these
days. Alas, I often encounter projects without tests or with bad
tests. Maybe you experienced this yourself, you changed something in a
specific part of the system and suddenly a lot of unrelated tests
fail. Congratulations, you made the acquaintance of <strong>brittle</strong> tests.
This is not only annoying for developers but also a time killer.
Another kind of bad tests are <strong>flaky</strong> tests. They are
non-deterministic due to relying on remote systems, making network
calls or accessing remote databases. This causes tests to randomly
succeed or fail even when production code has not changed.</p><p>Both, brittle and flaky, tests are a serious problems in a codebase
and should be shunned. Otherwise they will succumb progressively more
and more time and effort of the developers. Finally developers are
kept busy with repairing broken tests and productivity suffers. This
can happen in disguise and developers are not even aware of the
problem. In some companies test coverage is treated as a key
metric. Hence if the coverage high, nobody will question the current
situation. Maybe the whole involved team is proud of the high
coverage, not recognizing their real problem.</p><p>Maintainable, fast and deterministic unit tests build the foundation
of a sustainable codebase. But unit tests alone are not enough to
guarantee a usable, successful and bug-free application. Additionally
you need system and UI tests in order to verify production
readiness. The <strong>test pyramid</strong> visualizes this.</p><p align=center><img src=/img/test_pyramid.png alt=https://stackoverflow.com/questions/56696132/why-is-ui-testing-at-the-top-of-the-test-pyramid class=medium-zoom-image width=300></p><p>System tests and UI tests are good to check your product as a whole,
but these tests are slow, flaky, not repeatable and often are
conducted manually which makes them bad candidates for <a href=https://martinfowler.com/books/continuousDelivery.html>continuous
integration and
delivery</a>. If
system tests fail, it is hard for developers to locate the problem
because the scope of a system test is very broad and not as focused as
in a unit test. Relying heavily in a project on manual regression
testing instead of an exhaustive, automatic test suite is an
anti-pattern, the <strong>test ice cone</strong>. It is the inverse of the test
pyramid and leads to an unsustainable codebase because failing system
tests leave developers in the dark about the root cause and drain
their productivity. Did you ever work in a project with a Jira Board,
cluttered with unresolved Bugs in the backlog? &ndash; all bugs found by
so-called manual QAs or testers.</p><p align=center><img src=/img/ice_cone.jpg alt=https://watirmelon.blog/testing-pyramids/ class=medium-zoom-image width=300></p><p>In this article I will focus on unit tests. Good unit tests should be
clean, maintainable and most notably &ldquo;useful&rdquo; for developers. The main
purpose of tests is to save time for developers and keep the code
quality high. But careless use of testing can have negative effects on
productivity and code quality. E.g if developers loose a majority of
their time fixing tests instead of building new features. &ldquo;Wrong&rdquo;
testing can result in a system that requires even more effort to
maintain than without tests and takes more effort to change without
actually improving confidence in the next production release. It is
crucial to identify bad tests and to know how to write good tests.</p><p>This blog post is built upon the shoulder of giants. Basically I draw
from the fantastic book <a href=https://www.oreilly.com/library/view/software-engineering-at/9781492082781/>Software Engineering at
Google</a>
. Especially from Chapter 12 &ldquo;Unit Testing&rdquo;. I was also heavily
inspired by the article about <a href=https://medium.com/@kentbeck_7670/programmer-test-principles-d01c064d7934>Programmer Test
Principles</a>
from Kent Beck, the father of TDD.</p><h3 id=test-doubles>Test Doubles<a hidden class=anchor aria-hidden=true href=#test-doubles>#</a></h3><p><strong>Test Doubles</strong> play a crucial part in writing good unit tests, we&rsquo;ll
see soon. But first, let&rsquo;s define what a Test Double is. A Test Double
is a replacement of a production code class or function. Multiple
types of Test Doubles exist. In my opinion, the three most important
ones are:</p><ul><li>A <strong>Fake</strong> is a simplified implementation of a given interface, for
example a <em>FakeUserRepository</em> &ldquo;fakes&rdquo; the real database repository
behaviour with an in-memory Hashmap. A Fake is used interchangeably
with a real implementation and is typically applied via dependency
injection.</li><li>A <strong>Stub</strong> returns predefined, hard-coded values to specific calls
which are internally needed by the <strong>SUT</strong> (System Under Test) to
fulfill the tested behaviour.</li><li>A <strong>Mock</strong> is a stub, but additionally checks the interactions of
the mock with its environment. For example, was the mock called with
the expected parameters or was the mocked method called an expected
number of times? Checking the interactions of mocks is also called
<a href=https://www.oreilly.com/library/view/software-engineering-at/9781492082781/><strong>interaction
testing</strong></a>.
Naturally both, Stubbing and Mocking, is realized via
mock-frameworks.</li></ul><p>An exhaustive list of Test Double types can be found in <a href=https://martinfowler.com/bliki/TestDouble.html>Martin
Fowler&rsquo;s article</a>.</p><p>The following is a fake implementation of a UserRepository. An
in-memory Hashmap replaces a real database. The Fake can be used by a
unit test via dependency injection. There will be a relevant example
with an example usage later on.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Fake example
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>UserRepository</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>User user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> User <span style=color:#a6e22e>findById</span><span style=color:#f92672>(</span>String id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Fakes the UserRepository interface with a HashMap implementation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>FakeUserRepository</span> <span style=color:#66d9ef>implements</span> UserRepository <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> User<span style=color:#f92672>&gt;</span> users <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>User user<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        users<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>user<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>(),</span> user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> User <span style=color:#a6e22e>findById</span><span style=color:#f92672>(</span>String id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> users<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The next example shows a simple mock which stubs a method of the
UserRepository. Without the interaction verification at the end of the
test, the mock would be a simple stub.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// Mock example
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#f92672>import static</span> org.mockito.Mockito.*<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserServiceMockTest</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    UserRepository mockUserRepository <span style=color:#f92672>=</span> mock<span style=color:#f92672>(</span>UserRepository<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// dependency injection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    UserService sut <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> UserService<span style=color:#f92672>(</span>mockUserRepository<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>getUser_ReturnUser</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// arrange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        User user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> User<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        when<span style=color:#f92672>(</span>mockUserRepository<span style=color:#f92672>.</span><span style=color:#a6e22e>findById</span><span style=color:#f92672>(</span>anyString<span style=color:#f92672>())).</span><span style=color:#a6e22e>thenReturn</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span> <span style=color:#75715e>// stubbing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// act
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        User actual <span style=color:#f92672>=</span> sut<span style=color:#f92672>.</span><span style=color:#a6e22e>getUser</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// assert
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        assertEquals<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>,</span> actual<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// verify interaction
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// check that findById() was called with the correct parameter and exactly once
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        verify<span style=color:#f92672>(</span>mockUserRepository<span style=color:#f92672>,</span> times<span style=color:#f92672>(</span>1<span style=color:#f92672>)).</span><span style=color:#a6e22e>findById</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=what-makes-a-good-unit-test>What makes a good unit test?<a hidden class=anchor aria-hidden=true href=#what-makes-a-good-unit-test>#</a></h3><p>There are a lot of opinions floating around about how to write good
unit tests. In the following I list the traits which I consider most
important.</p><h4 id=tests-should-be-fast>Tests should be fast<a hidden class=anchor aria-hidden=true href=#tests-should-be-fast>#</a></h4><p>A useful test suite will be run frequently, sometimes multiple times a
minute, and therefore must be fast, i.e. a few seconds at
most. Loosing focus during the run is unwanted because it decreases
productivity and breaks the flow. Further if unit tests are slow,
developers will not run tests regularly or skip running them
completely. Then tests will loose their purpose, namely providing fast
feedback. Martin Fowler speaks of a <strong><a href=https://martinfowler.com/bliki/UnitTest.html>compile suite and a commit
suite</a></strong>. Normally
developers work on a specific part or unit of a system like a single
file or class. With every compilation, they only run the related tests
to get feedback as fast as possible. Hence this group of tests is the
&ldquo;compile suite&rdquo;. The compile suite comprises the smallest set of tests
which verify the correctness of the unit of the system which is
currently worked on. After finishing a feature or bugfix, before
committing, all unit tests are run to check if nothing else is
broken. Hence this group of tests is called the &ldquo;commit suite&rdquo;.</p><p>The optimal duration of a unit test is in the nanosecond
range. Hundred milliseconds sounds fast for a single unit test but it
is too slow if you think about a project with multiple thousand
tests. All tests would take minutes to complete. A developer will only
reluctantly wait or even worse he will skip running the tests.</p><p>Tests, relying on network calls, database queries or time related
logic, are inherently slow. Test Doubles are a mechanism to make tests
fast and reliable. With a Test Double you <em>inject</em> a fake
implementation replacing the database or HTTP call. This technique is
well known as <a href=https://martinfowler.com/articles/injection.html#InversionOfControl>Dependency
Injection</a>.</p><p>In the code block below the UserService uses the UserRepository to
carry out the intended business logic. A real UserRepository talks
naturally to a database and is too slow for a unit test. Here the real
database implementation is substituted with a FakeUserRepository from
above.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserServiceTest</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// test double
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    UserRepository fakeUserRepository <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> FakeUserRepository<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// dependency injection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    UserService sut <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> UserService<span style=color:#f92672>(</span>fakeUserRepository<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>registerUser_validUser_success</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// arrange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        User user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> User<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;foobar&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// act
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        sut<span style=color:#f92672>.</span><span style=color:#a6e22e>registerUser</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// assert
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        User u <span style=color:#f92672>=</span> sut<span style=color:#f92672>.</span><span style=color:#a6e22e>getUser</span><span style=color:#f92672>(</span>user<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        assertNotNull<span style=color:#f92672>(</span>u<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=tests-should-be-isolated>Tests should be isolated<a hidden class=anchor aria-hidden=true href=#tests-should-be-isolated>#</a></h4><p>Tests should be independent from each other. It must be possible to
run the tests in any order, concurrently and in parallel. This becomes
especially important when the project is big and contains thousand of
tests. In order to speed up the build, the workload can be distributed
across different machines. The distribution logic is very simple if
the tests are isolated. Contrary, it would be very hard or even
impossible to distribute tests which make up a complex dependency
graph. Further any single unit test should be able to run alone
without depending on other unit tests, files, network I/O, and
databases.</p><p>Below there is an example of a bad unit test. The second test depends
on the first one and it will fail if the first test did not run
before or failed. Not only this eradicates the possibility to
distribute the tests but also developers will have a hard time to
figure out the root cause of the potential error. Did the second test
fail because of itself or because of the test before?</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// BAD
</span></span></span><span style=display:flex><span><span style=color:#75715e>// tests depend on each other and cannot run in random order or concurrently
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@TestMethodOrder</span><span style=color:#f92672>(</span>MethodOrderer<span style=color:#f92672>.</span><span style=color:#a6e22e>OrderAnnotation</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BankAccountServiceOrderedTest</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    BankAccountService sut <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BankAccountService<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    User user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> User<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Order</span><span style=color:#f92672>(</span>1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>createAccount_validUser_ok</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// act
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        sut<span style=color:#f92672>.</span><span style=color:#a6e22e>createAccount</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// assert
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>boolean</span> actual <span style=color:#f92672>=</span> sut<span style=color:#f92672>.</span><span style=color:#a6e22e>hasAccount</span><span style=color:#f92672>(</span>user<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        assertTrue<span style=color:#f92672>(</span>actual<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Order</span><span style=color:#f92672>(</span>2<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deposit_100Dollars_ok</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// arrange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Integer amount <span style=color:#f92672>=</span> 100<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// act
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Integer actual <span style=color:#f92672>=</span> sut<span style=color:#f92672>.</span><span style=color:#a6e22e>deposit</span><span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> amount<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// assert
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Integer expected <span style=color:#f92672>=</span> 100<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        assertEquals<span style=color:#f92672>(</span>expected<span style=color:#f92672>,</span> actual<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The second example shows two independent tests. The small cost of
adding 2-3 lines per tests is more than acceptable.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// GOOD
</span></span></span><span style=display:flex><span><span style=color:#75715e>// tests can run in random order and concurrently
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@TestMethodOrder</span><span style=color:#f92672>(</span>MethodOrderer<span style=color:#f92672>.</span><span style=color:#a6e22e>Random</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BankAccountServiceTest</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    BankAccountService sut <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> BankAccountService<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@BeforeEach</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>beforeEach</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        sut<span style=color:#f92672>.</span><span style=color:#a6e22e>resetAll</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>deposit_100Dollars_ok</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// arrange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        User user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> User<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sut<span style=color:#f92672>.</span><span style=color:#a6e22e>createAccount</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Integer amount <span style=color:#f92672>=</span> 100<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// act
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Integer actual <span style=color:#f92672>=</span> sut<span style=color:#f92672>.</span><span style=color:#a6e22e>deposit</span><span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> amount<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// assert
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Integer expected <span style=color:#f92672>=</span> 100<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        assertEquals<span style=color:#f92672>(</span>expected<span style=color:#f92672>,</span> actual<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>withdraw_50Dollars_ok</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// arrange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        User user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> User<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sut<span style=color:#f92672>.</span><span style=color:#a6e22e>createAccount</span><span style=color:#f92672>(</span>user<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        sut<span style=color:#f92672>.</span><span style=color:#a6e22e>deposit</span><span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> 100<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        Integer amount <span style=color:#f92672>=</span> 50<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// act
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Integer actual <span style=color:#f92672>=</span> sut<span style=color:#f92672>.</span><span style=color:#a6e22e>withdraw</span><span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> amount<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// assert
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Integer expected <span style=color:#f92672>=</span> 50<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        assertEquals<span style=color:#f92672>(</span>expected<span style=color:#f92672>,</span> actual<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=tests-should-be-deterministic>Tests should be deterministic<a hidden class=anchor aria-hidden=true href=#tests-should-be-deterministic>#</a></h4><p>A deterministic test never changes its outcome when there was no
change of behaviour. A test switching from green to red or the other
way around without any change is called flaky. Test Doubles are a good
way to get rid of flaky dependencies like external network or database
calls. The earlier example with the FakeUserRepository demonstrates
this.</p><h4 id=tests-should-focus-on-a-single-unit-of-the-system>Tests should focus on a single unit of the system<a hidden class=anchor aria-hidden=true href=#tests-should-focus-on-a-single-unit-of-the-system>#</a></h4><p>A unit test should focus on a single part of the system. If a unit
tests breaks, it should be easy to find the root cause. The other way
around is also true: If someone changes a unit, only corresponding
unit tests should possibly break. If you need to start a debugger to
figure out what went wrong, the chance is high that your tests are too
diffuse and include much more than a single unit.</p><p>Unit tests which not focus on a single unit tend to be brittle because
they will fail if some other part of the system changes. Brittle tests
are a serious problem because developers loose trust in the test suite
and they neglect badly needed refactorings. This hampers
maintainability and causes the quality of the codebase to
degrade. More often than not, in many projects existing unit tests are
more a burden than a backing for the developers.</p><p>Often there is a misunderstanding of what &ldquo;focus on one unit&rdquo; exactly
means. Here the two types of testing, the <a href=https://martinfowler.com/articles/mocksArentStubs.html#ClassicalAndMockistTesting>classic testing and the
mockist
testing</a>,
come into play. The &ldquo;mockists&rdquo; are very strict and mock all
dependencies. The mock-everything approach isolates the test from the
rest of the world but comes with major disadvantages. First, the unit
tests are polluted with various mock-statements which makes the real
test logic hard to understand. And second, with mocking the
dependencies, you expose the internals of the unit. This is a major
bummer because once the internals are exposed, future refactorings are
impossible without breaking a majority of existing tests. The &ldquo;classic
tester&rdquo; avoid mocks and use Fakes or real implementations for
dependencies. Hence the internals are kept hidden and refactorings are
still possible.</p><p>You can find a great definition about &ldquo;focus on a single unit&rdquo; in the
book <a href=https://www.oreilly.com/library/view/software-engineering-at/9781492082781/>Software Engineering at
Google</a>:</p><blockquote><p>It’s important to note that when we talk about unit tests as being narrowly scoped, we’re referring to the code that is being validated, not the code that is being executed.</p></blockquote><h4 id=tests-should-be-enduring>Tests should be enduring<a hidden class=anchor aria-hidden=true href=#tests-should-be-enduring>#</a></h4><p>Strive for unchangeable tests. A test should be written once and never
be touched except there is a change of behaviour in the corresponding
unit. Changes of internals should never break a test if the behaviour
stays the same. Like I mentioned earlier these are brittle tests. We
should prevent them at any cost.</p><p>Brittle tests can creep into the codebase because of the overuse of
mocks. Mocks verify if specific methods get called. Hence mocks know
about the internal implementation which makes the tests prone to
failures. If the internal implementation changes, you need to adjust
all tests which use related mocks. In large codebases this means a lot
of effort.</p><p>Test only <em>public</em> methods. I often see developers who test private
methods. Therefore they make them public or protected. This
contradicts the concept of information hiding and low coupling. Then
you expose the internals of a unit which makes it impossible to switch
the internal implementation without breaking a majority of
tests. Additionally, you crippled the module&rsquo;s contract and swamped
its interface with confusing public methods which should be private.</p><h4 id=tests-should-be-clear-concise-and-complete>Tests should be clear, concise and complete<a hidden class=anchor aria-hidden=true href=#tests-should-be-clear-concise-and-complete>#</a></h4><p>A test should be clear, concise and complete. What does that mean
exactly? A clear test is easy to read and to understand. Tests should
not include complex logic like nested if-conditions or complicated
loops. A clear test is a simple sequence of expressions without any
branching. Consistency is critical. All tests in a project should
comply to a common structure like <em>arrange-act-assert</em> or
<em>given-when-then</em>. A consistent structure reduces cognitive load and
gives developers, unfamiliar with the codebase, a prescriptive model
how a test should look like. A consistent naming pattern adds clarity
and bolsters readability. A collection of common patterns can be found
<a href=https://dzone.com/articles/7-popular-unit-test-naming>here</a>. My
preferred one is <code>UnitName_StateUnderTest_ExpectedBehavior</code>. Rich
failure messages are important too. A message with a detailed context
where and why the test failed, reduces debugging effort
immensely. According to
<a href=https://docs.microsoft.com/en-us/dotnet/core/testing/unit-testing-best-practices>Microsoft</a>
you should create a separate test for each assertion. In case of a
test failure, a single assertion helps to demystify the error. Most
testing-frameworks anyway stop during the first assertion error per
test. At best, a visible correlation from the test name to the
assertion statement exist. Multiple assertions could be useful though
for asserting multiple attributes of a complex object or checking
expected side-effects.</p><p>The following test shows one good assertion and some
unnecessary ones:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PaymentServiceTest</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    PaymentService sut <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PaymentService<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> PaymentGateway<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@DisplayName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;payment with valid user&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>pay_validUser_success</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// arrange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        User user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> User<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setHasValidCreditCard</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> amount <span style=color:#f92672>=</span> 750<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        PaymentRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PaymentRequest<span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> amount<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// act
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        PaymentResponse actual <span style=color:#f92672>=</span> sut<span style=color:#f92672>.</span><span style=color:#a6e22e>pay</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// assert
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// GOOD one assert is enough to cover the test case
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>boolean</span> expected <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        assertEquals<span style=color:#f92672>(</span>expected<span style=color:#f92672>,</span> actual<span style=color:#f92672>.</span><span style=color:#a6e22e>isSuccess</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// BAD
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// unnecessary over-assertion
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        assertEquals<span style=color:#f92672>(</span>expectedReason<span style=color:#f92672>,</span> actual<span style=color:#f92672>.</span><span style=color:#a6e22e>getReason</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        assertEquals<span style=color:#f92672>(</span>expectedStateOfSUT<span style=color:#f92672>,</span> sut<span style=color:#f92672>.</span><span style=color:#a6e22e>getState</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        assertEquals<span style=color:#f92672>(</span>expectedOther<span style=color:#f92672>,</span> otherStuffNonRelatedToTest<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Completeness and conciseness contradict themselves. A good test finds
a balance of both. The highest priority is readability though which is
fostered by completeness. A <em>complete</em> test contains all dependencies,
pre-configured objects and data needed to run the test. The apt
developer must resist the urge to make the test too DRY (Don&rsquo;t Repeat
Yourself). DRY code scatters important shared logic and hurts
readability. Relying too much on shared helper classes and functions
reduces the amount of code but increases coupling and makes tests
brittle. <a href=https://testing.googleblog.com/2019/12/testing-on-toilet-tests-too-dry-make.html>Google&rsquo;s Testing on the Toilet
Blog</a>
favors the <strong>DAMP</strong> principle (<em>Descriptive And Meaningful Phrases</em>)
over the DRY principle for tests. A little duplication improves
comprehension and should be preferred over uniqueness. If you think
complete tests are too verbose or your tests require lots of setup
code, it could be an indicator that your production code is flawed and
you should rethink your overall design.</p><p>The following examples show a test in a DRY and a DAMP version. The
DRY version uses shared helper functions like <code>createUsers()</code> or
<code>validate()</code> with unclear semantics. The DAMP version replaces these
magical functions with a simple constructor call and an assertion
statement.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// BAD
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// test is too DRY
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// What kind of users will be created by the createUsers() function?
</span></span></span><span style=display:flex><span><span style=color:#75715e>// What will be asserted by the validate() function?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PaymentServiceDRYTest</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// magical helper function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    List<span style=color:#f92672>&lt;</span>User<span style=color:#f92672>&gt;</span> users <span style=color:#f92672>=</span> createUsers<span style=color:#f92672>();</span> <span style=color:#75715e>// how many users will be created?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@DisplayName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;payment with valid user&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>pay_validUser_success</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// arrange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        PaymentService sut <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PaymentService<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> PaymentGateway<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// BAD
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// which user in the list is a valid one?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        PaymentRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PaymentRequest<span style=color:#f92672>(</span>users<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>0<span style=color:#f92672>),</span> 750<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// act
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        PaymentResponse actual <span style=color:#f92672>=</span> sut<span style=color:#f92672>.</span><span style=color:#a6e22e>pay</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// assert
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// magical helper function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        validate<span style=color:#f92672>(</span>actual<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>  <span style=color:#75715e>// what are these parameters?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// validate() is used in other contexts too
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// the three parameters are: validate(actual, expected, errorMessage)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// GOOD
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Test is DAMP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// all information needed for the test are inside the test
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PaymentServiceDAMPTest</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    PaymentService sut <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PaymentService<span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> PaymentGateway<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@DisplayName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;payment with valid user&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>pay_validUser_success</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// arrange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        User user <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> User<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;userId&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setHasValidCreditCard</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> amount <span style=color:#f92672>=</span> 750<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        PaymentRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PaymentRequest<span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> amount<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// act
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        PaymentResponse actual <span style=color:#f92672>=</span> sut<span style=color:#f92672>.</span><span style=color:#a6e22e>pay</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// assert
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>boolean</span> expected <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        assertEquals<span style=color:#f92672>(</span>expected<span style=color:#f92672>,</span> actual<span style=color:#f92672>.</span><span style=color:#a6e22e>isSuccess</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Nevertheless conciseness is important too and must not be neglected. A
deliberate usage of shared helpers makes this possible. For example,
after calling the helper function you could explicitly set the needed
properties for the test on the returned object. So you utilize the
shared helper function but also decouple the test from it. Further the
relevant properties, needed by the test, are made prominent and the
test will be stable even if someone changes the helper logic. The
example below illustrates that.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>// BAD use of shared helper function.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// We don&#39;t know about the properties of the created user.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// If someone changes createDefaultUser(), the test could break.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>pay_validUser_success3</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// arrange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        User user <span style=color:#f92672>=</span> createDefaultUser<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> amount <span style=color:#f92672>=</span> 750<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        PaymentRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PaymentRequest<span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> amount<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// act
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        PaymentResponse actual <span style=color:#f92672>=</span> sut<span style=color:#f92672>.</span><span style=color:#a6e22e>pay</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// assert
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>boolean</span> expected <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        assertEquals<span style=color:#f92672>(</span>expected<span style=color:#f92672>,</span> actual<span style=color:#f92672>.</span><span style=color:#a6e22e>isSuccess</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// GOOD use of shared helper function.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Set properties which matter for the test explicitly.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Test is complete.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// You understand the test without checking createDefaultUser().
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Even if someone changes createDefaultUser(), the test will be ok.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>pay_validUser_success2</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// arrange
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        User user <span style=color:#f92672>=</span> createDefaultUser<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        user<span style=color:#f92672>.</span><span style=color:#a6e22e>setHasValidCreditCard</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> amount <span style=color:#f92672>=</span> 750<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        PaymentRequest request <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> PaymentRequest<span style=color:#f92672>(</span>user<span style=color:#f92672>,</span> amount<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// act
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        PaymentResponse actual <span style=color:#f92672>=</span> sut<span style=color:#f92672>.</span><span style=color:#a6e22e>pay</span><span style=color:#f92672>(</span>request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// assert
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>boolean</span> expected <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        assertEquals<span style=color:#f92672>(</span>expected<span style=color:#f92672>,</span> actual<span style=color:#f92672>.</span><span style=color:#a6e22e>isSuccess</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=tests-should-give-you-confidence-and-a-good-feeling>Tests should give you confidence (and a good feeling)<a hidden class=anchor aria-hidden=true href=#tests-should-give-you-confidence-and-a-good-feeling>#</a></h4><p>Finally your test suite should give you confidence that your code
changes are correct and you did not break anything. A green suite is
an indicator that you can deploy to production without worries. Green
tests should give the individual developer a good feeling about his
code changes. Thereby tests act as a productivity booster so you can
make changes faster and deliver features in less time &ndash; always
feeling good at it.</p><h4 id=the-fallacy-of-mocking>The Fallacy Of Mocking<a hidden class=anchor aria-hidden=true href=#the-fallacy-of-mocking>#</a></h4><p>We learned that mocks make unit tests fast and deterministic. They
prevent flaky tests because they replace unstable calls or slow
network calls with predefined, hard-coded behaviour. There is a catch
though. The overuse of mocking or stubbing has a negative effect on
your test code quality:</p><ol><li><p>Tests become unclear because mock statements bloat the code and
make the test hard to comprehend. The maintainability of your test
code suffers.</p></li><li><p>Tests become brittle. The more you mock, the more internals of the
SUT are leaked. Changing the internals, even without changing the
behaviour of the SUT, could make the test fail which contradicts
the principle of enduring tests.</p></li><li><p>A need of too many mocks could be an indicator of bad design. Most
probably the SUT has too many dependencies and responsibilities and
should be divided.</p></li></ol><p><a href=https://www.oreilly.com/library/view/software-engineering-at/9781492082781/>Google</a>
also warns about the overuse of mock-frameworks and interaction
testing. Nevertheless interaction testing is sometimes the only way
to check the code correctness. For example in order to check a
caching logic, you need to call a function twice. First to get object
and to fill the cache, second to get the object from the cache. Both
returned objects are indistinguishable. The only way to verify that
the second object was retrieved from the cache is to check if the
cache was called. Another insight from Google is that they prefer
<em>Fakes over Mocks</em>. Fakes are not that intrusive and the test code is
not swamped by stubbing-behaviour statements.</p><h4 id=final-words>Final words<a hidden class=anchor aria-hidden=true href=#final-words>#</a></h4><p>I know some presented traits are idealistic. Ideals are often hard or
even impossible to achieve. Nevertheless these &ldquo;ideals&rdquo; should serve
you as a guide star. I hope you gained some new insights and
understand that good unit tests play a crucial part for a successful
software project. Especially identifying good and bad tests is
important, so you do not fall into the trap of brittle or flaky
tests. Eventually tests exist to make the life of developers
easier. When tests do not increase productivity, confidence and code
quality, they failed their purpose. I also hope that I could eliminate
some fallacies about mocking or that chasing a 100% code coverage is
nonsense. As long developers feel confident about their codebase and
refactorings are done regularly everything is fine.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://gerlacdt.github.io/tags/programming/>programming</a></li><li><a href=https://gerlacdt.github.io/tags/testing/>testing</a></li></ul><nav class=paginav><a class=prev href=https://gerlacdt.github.io/posts/programming-quotes/><span class=title>« Prev Page</span><br><span>Programming Quotes</span></a>
<a class=next href=https://gerlacdt.github.io/posts/eslint-prettier-typescript/><span class=title>Next Page »</span><br><span>ESlint + Prettier + Typescript = Consistency</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Why and How to write better Unit Tests on twitter" href="https://twitter.com/intent/tweet/?text=Why%20and%20How%20to%20write%20better%20Unit%20Tests&url=https%3a%2f%2fgerlacdt.github.io%2fposts%2funit-testing%2f&hashtags=programming%2ctesting"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Why and How to write better Unit Tests on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fgerlacdt.github.io%2fposts%2funit-testing%2f&title=Why%20and%20How%20to%20write%20better%20Unit%20Tests&summary=Why%20and%20How%20to%20write%20better%20Unit%20Tests&source=https%3a%2f%2fgerlacdt.github.io%2fposts%2funit-testing%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Why and How to write better Unit Tests on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fgerlacdt.github.io%2fposts%2funit-testing%2f&title=Why%20and%20How%20to%20write%20better%20Unit%20Tests"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Why and How to write better Unit Tests on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fgerlacdt.github.io%2fposts%2funit-testing%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Why and How to write better Unit Tests on whatsapp" href="https://api.whatsapp.com/send?text=Why%20and%20How%20to%20write%20better%20Unit%20Tests%20-%20https%3a%2f%2fgerlacdt.github.io%2fposts%2funit-testing%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Why and How to write better Unit Tests on telegram" href="https://telegram.me/share/url?text=Why%20and%20How%20to%20write%20better%20Unit%20Tests&url=https%3a%2f%2fgerlacdt.github.io%2fposts%2funit-testing%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://gerlacdt.github.io/>Daniel's programming rants</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>